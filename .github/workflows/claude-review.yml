name: Claude Code Review

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup script permissions
        run: chmod +x .github/scripts/claude-review.sh
      
      - name: Get changed files and diff
        id: get-diff
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "Getting PR diff..."
            git diff ${{ github.event.pull_request.base.sha }}..${{ github.sha }} > diff.txt
            
            # Get list of changed files
            git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.sha }} > changed_files.txt
            
            # For newly opened PRs, always process the diff (don't check if empty)
            if [ "${{ github.event.action }}" == "opened" ]; then
              echo "First PR review - processing all changes"
              echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
              DIFF_SIZE=$(wc -l < diff.txt)
              echo "Diff size: $DIFF_SIZE lines"
              exit 0
            fi
          else
            echo "Getting push diff..."
            # For push events, compare with previous commit
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              git diff HEAD~1 HEAD > diff.txt
              git diff --name-only HEAD~1 HEAD > changed_files.txt
            else
              # First commit in repo
              git show HEAD > diff.txt
              git diff-tree --no-commit-id --name-only -r HEAD > changed_files.txt
            fi
          fi
          
          # Display changed files
          echo "Changed files:"
          cat changed_files.txt
          
          # Check if diff is empty (for synchronize/reopened PRs and push events)
          if [ ! -s diff.txt ]; then
            echo "No changes detected"
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
          else
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
            # Show diff size
            DIFF_SIZE=$(wc -l < diff.txt)
            echo "Diff size: $DIFF_SIZE lines"
          fi
      
      - name: Review code with Claude
        if: steps.get-diff.outputs.HAS_CHANGES == 'true'
        id: claude-review
        run: |
          # Run the review script
          ./.github/scripts/claude-review.sh diff.txt review.md
          
          # Capture the review output for GitHub Actions
          if [ -f review.md ]; then
            echo "REVIEW<<EOFMARKER" >> $GITHUB_OUTPUT
            cat review.md >> $GITHUB_OUTPUT
            echo "EOFMARKER" >> $GITHUB_OUTPUT
            
            echo "‚úÖ Review completed successfully"
          else
            echo "‚ùå Review file not created"
            exit 1
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      
      - name: Upload review artifact
        if: steps.get-diff.outputs.HAS_CHANGES == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: claude-review-${{ github.sha }}
          path: |
            review.md
            diff.txt
            changed_files.txt
          retention-days: 30
      
      - name: Ensure label exists
        if: github.event_name == 'push' && github.ref_name != 'main' && steps.get-diff.outputs.HAS_CHANGES == 'true'
        run: |
          gh label create "automated-review" \
            --description "Automated code reviews by Claude AI" \
            --color "0E8A16" 2>/dev/null || echo "Label already exists"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Create or update PR for push
        if: github.event_name == 'push' && github.ref_name != 'main' && steps.get-diff.outputs.HAS_CHANGES == 'true'
        id: create-pr
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          BASE_BRANCH="main"
          
          echo "Checking for existing PR from $BRANCH_NAME to $BASE_BRANCH..."
          
          # Check if PR already exists
          PR_NUMBER=$(gh pr list \
            --head "$BRANCH_NAME" \
            --base "$BASE_BRANCH" \
            --json number \
            --jq '.[0].number' 2>/dev/null || echo "")
          
          if [ -z "$PR_NUMBER" ]; then
            echo "Creating new PR with minimal comment..."
            
            # Create PR body with short comment to avoid full review notification
            cat > pr_body.md << 'EOFBODY'
          ## ü§ñ Automated PR

          This PR was automatically created for code changes on `${{ github.ref_name }}`.
          
          A detailed Claude AI code review will be posted as a comment below.

          ---
          - **Branch**: `${{ github.ref_name }}`
          - **Commit**: `${{ github.sha }}`
          - **Model**: Claude Sonnet 4
          EOFBODY
            
            PR_OUTPUT=$(gh pr create \
              --title "ü§ñ Claude Review: Updates to $BRANCH_NAME" \
              --body-file pr_body.md \
              --base "$BASE_BRANCH" \
              --head "$BRANCH_NAME" \
              --label "automated-review" 2>&1) || PR_FAILED=true
            
            if [ "$PR_FAILED" == "true" ]; then
              echo "‚ö†Ô∏è PR creation failed with output:"
              echo "$PR_OUTPUT"
              
              # Check if branches are identical
              if git diff --quiet origin/$BASE_BRANCH...$BRANCH_NAME; then
                echo "‚ÑπÔ∏è No differences between $BASE_BRANCH and $BRANCH_NAME - PR not needed"
              fi
            else
              # Extract PR number from output
              PR_NUMBER=$(echo "$PR_OUTPUT" | grep -oP 'https://github.com/.*/pull/\K[0-9]+' || echo "")
              echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
              echo "PR_CREATED=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "PR #$PR_NUMBER already exists."
            echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "PR_CREATED=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      
      - name: Comment on PR
        if: steps.get-diff.outputs.HAS_CHANGES == 'true' && (github.event_name == 'pull_request' || steps.create-pr.outputs.PR_NUMBER != '')
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = process.env.REVIEW_CONTENT;
            const eventName = '${{ github.event_name }}';
            const prNumber = eventName === 'pull_request' 
              ? context.issue.number 
              : parseInt('${{ steps.create-pr.outputs.PR_NUMBER }}');
            
            if (!prNumber) {
              console.log('No PR number available, skipping comment');
              return;
            }
            
            const body = `## ü§ñ Claude AI Code Review
            
            ${review}
            
            ---
            <details>
            <summary>‚ÑπÔ∏è Review Details</summary>
            
            - **Commit**: \`${{ github.sha }}\`
            - **Model**: Claude Sonnet 4
            - **Triggered by**: ${eventName}
            
            </details>
            
            *Automated review by bot*`;
            
            // Check for existing bot comments
            const comments = await github.rest.issues.listComments({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ü§ñ Claude AI Code Review')
            );
            
            if (botComment) {
              // Check if review content has changed
              if (botComment.body.includes(review.substring(0, 100))) {
                console.log('Review content unchanged, skipping update');
                return;
              }
              
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('Updated existing comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
              console.log('Created new comment');
            }
        env:
          REVIEW_CONTENT: ${{ steps.claude-review.outputs.REVIEW }}
        
      - name: Report status
        if: always()
        run: |
          if [ "${{ steps.get-diff.outputs.HAS_CHANGES }}" == "false" ]; then
            echo "‚ÑπÔ∏è No changes detected - skipping review"
          elif [ "${{ steps.claude-review.outcome }}" == "success" ]; then
            echo "‚úÖ Claude review completed successfully"
          else
            echo "‚ùå Claude review failed"
            exit 1
          fi