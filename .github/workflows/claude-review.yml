name: Claude Code Review

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} > changed_files.txt
          else
            git diff --name-only HEAD~1 HEAD > changed_files.txt
          fi
          echo "Files changed:"
          cat changed_files.txt
      
      - name: Get file diffs
        id: get-diffs
        run: |
          echo "DIFFS<<EOF" >> $GITHUB_OUTPUT
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }}
          else
            git diff HEAD~1 HEAD
          fi >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Review code with Claude
        id: claude-review
        run: |
          DIFF="${{ steps.get-diffs.outputs.DIFFS }}"
          
          # Create the prompt for Claude
          PROMPT="You are a senior code reviewer. Review the following code changes and provide:
          1. A summary of the changes
          2. Potential bugs or issues
          3. Security concerns
          4. Performance improvements
          5. Best practice suggestions
          6. Specific line-by-line suggestions in the format: 'File: filename.ext, Line: X - Suggestion: your suggestion'
          
          Here are the code changes:
          \`\`\`diff
          ${DIFF}
          \`\`\`
          
          Provide your review in markdown format."
          
          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d '{
              "model": "claude-sonnet-4-20250514",
              "max_tokens": 4096,
              "messages": [{
                "role": "user",
                "content": "'"${PROMPT//\"/\\\"}"'"
              }]
            }')
          
          # Extract the review text
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text')
          
          # Save review to file
          echo "$REVIEW" > review.md
          echo "Review saved to review.md"
          
          # Save for next step
          echo "REVIEW<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create or update PR with suggestions
        if: github.event_name == 'push'
        run: |
          # Check if a PR already exists for this branch
          BRANCH_NAME="${{ github.ref_name }}"
          BASE_BRANCH="main"
          
          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --base "$BASE_BRANCH" --json number --jq '.[0].number')
          
          if [ -z "$PR_EXISTS" ]; then
            # Create new PR
            gh pr create \
              --title "ðŸ¤– Claude Review: Updates to $BRANCH_NAME" \
              --body "## Automated Code Review by Claude

          ${{ steps.claude-review.outputs.REVIEW }}

          ---
          *This PR was automatically created by Claude AI based on recent changes.*" \
              --base "$BASE_BRANCH" \
              --head "$BRANCH_NAME"
          else
            # Update existing PR
            gh pr comment "$PR_EXISTS" --body "## Updated Code Review by Claude

          ${{ steps.claude-review.outputs.REVIEW }}

          ---
          *Review updated: $(date)*"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment on existing PR
        if: github.event_name == 'pull_request'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "## ðŸ¤– Claude Code Review

          ${{ steps.claude-review.outputs.REVIEW }}

          ---
          *Automated review by Claude AI*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}