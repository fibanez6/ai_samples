name: Claude Code Review

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup script permissions
        run: chmod +x .github/scripts/claude-review.sh
      
      - name: Get changed files and diff
        id: get-diff
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "Getting PR diff..."
            git diff ${{ github.event.pull_request.base.sha }}..${{ github.sha }} > diff.txt
            
            # Get list of changed files
            git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.sha }} > changed_files.txt
          else
            echo "Getting push diff..."
            # For push events, compare with previous commit
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              git diff HEAD~1 HEAD > diff.txt
              git diff --name-only HEAD~1 HEAD > changed_files.txt
            else
              # First commit in repo
              git show HEAD > diff.txt
              git diff-tree --no-commit-id --name-only -r HEAD > changed_files.txt
            fi
          fi
          
          # Display changed files
          echo "Changed files:"
          cat changed_files.txt
          
          # Check if diff is empty
          if [ ! -s diff.txt ]; then
            echo "No changes detected"
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
          else
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
            # Show diff size
            DIFF_SIZE=$(wc -l < diff.txt)
            echo "Diff size: $DIFF_SIZE lines"
          fi
      
      - name: Review code with Claude
        if: steps.get-diff.outputs.HAS_CHANGES == 'true'
        id: claude-review
        run: |
          # Run the review script
          ./.github/scripts/claude-review.sh diff.txt review.md
          
          # Capture the review output for GitHub Actions
          if [ -f review.md ]; then
            echo "REVIEW<<EOFMARKER" >> $GITHUB_OUTPUT
            cat review.md >> $GITHUB_OUTPUT
            echo "EOFMARKER" >> $GITHUB_OUTPUT
            
            echo "‚úÖ Review completed successfully"
          else
            echo "‚ùå Review file not created"
            exit 1
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      
      - name: Upload review artifact
        if: steps.get-diff.outputs.HAS_CHANGES == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: claude-review-${{ github.sha }}
          path: |
            review.md
            diff.txt
            changed_files.txt
          retention-days: 30
      
      - name: Ensure label exists
        if: github.event_name == 'push' && github.ref_name != 'main' && steps.get-diff.outputs.HAS_CHANGES == 'true'
        run: |
          gh label create "automated-review" \
            --description "Automated code reviews by Claude AI" \
            --color "0E8A16" 2>/dev/null || echo "Label already exists"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.get-diff.outputs.HAS_CHANGES == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const review = `## ü§ñ Claude AI Code Review
            
            ${{ steps.claude-review.outputs.REVIEW }}
            
            ---
            <details>
            <summary>‚ÑπÔ∏è Review Details</summary>
            
            - **Commit**: \`${{ github.sha }}\`
            - **Model**: Claude Sonnet 4
            - **Triggered by**: ${{ github.event_name }}
            
            </details>
            
            *Automated review ‚Ä¢ [View full diff](${{ github.event.pull_request.html_url }}/files)*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: review
            });
      
      - name: Create or update PR for push
        if: github.event_name == 'push' && github.ref_name != 'main' && steps.get-diff.outputs.HAS_CHANGES == 'true'
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          BASE_BRANCH="main"
          
          echo "Checking for existing PR from $BRANCH_NAME to $BASE_BRANCH..."
          
          # Check if PR already exists
          PR_NUMBER=$(gh pr list \
            --head "$BRANCH_NAME" \
            --base "$BASE_BRANCH" \
            --json number \
            --jq '.[0].number' 2>/dev/null || echo "")
          
          # Save review to temp file to avoid shell escaping issues
          cat > pr_body.md << 'EOFBODY'
          ## ü§ñ Automated Code Review by Claude

          ${{ steps.claude-review.outputs.REVIEW }}

          ---
          ### üìä Review Information
          - **Branch**: `${{ github.ref_name }}`
          - **Commit**: `${{ github.sha }}`
          - **Triggered by**: Push event
          - **Model**: Claude Sonnet 4

          *This PR was automatically created based on code changes. Review the suggestions above and merge when ready.*
          EOFBODY
          
          if [ -z "$PR_NUMBER" ]; then
            echo "Creating new PR..."
            PR_OUTPUT=$(gh pr create \
              --title "ü§ñ Claude Review: Updates to $BRANCH_NAME" \
              --body "$PR_BODY" \
              --base "$BASE_BRANCH" \
              --head "$BRANCH_NAME" \
              --label "automated-review" 2>&1) || PR_FAILED=true
            
            if [ "$PR_FAILED" == "true" ]; then
              echo "‚ö†Ô∏è PR creation failed with output:"
              echo "$PR_OUTPUT"
              
              # Check if branches are identical
              if git diff --quiet origin/$BASE_BRANCH...$BRANCH_NAME; then
                echo "‚ÑπÔ∏è No differences between $BASE_BRANCH and $BRANCH_NAME - PR not needed"
              fi
            fi
          else
            echo "PR #$PR_NUMBER already exists. Adding comment..."
            
            # Create comment body
            cat > comment_body.md << 'EOFCOMMENT'
          ## üîÑ Updated Code Review

          ${{ steps.claude-review.outputs.REVIEW }}

          ---
          *Review updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          *Commit*: `${{ github.sha }}`
          EOFCOMMENT
            
            gh pr comment "$PR_NUMBER" --body-file comment_body.md
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Report status
        if: always()
        run: |
          if [ "${{ steps.get-diff.outputs.HAS_CHANGES }}" == "false" ]; then
            echo "‚ÑπÔ∏è No changes detected - skipping review"
          elif [ "${{ steps.claude-review.outcome }}" == "success" ]; then
            echo "‚úÖ Claude review completed successfully"
          else
            echo "‚ùå Claude review failed"
            exit 1
          fi