name: Claude Code Review with GitHub MCP

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install MCP GitHub Server
        run: |
          npm install -g @modelcontextprotocol/server-github
      
      - name: Get PR or Push Context
        id: context
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "BASE_SHA=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
            echo "HEAD_SHA=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "IS_PR=true" >> $GITHUB_OUTPUT
          else
            echo "BASE_SHA=$(git rev-parse HEAD~1)" >> $GITHUB_OUTPUT
            echo "HEAD_SHA=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
            echo "IS_PR=false" >> $GITHUB_OUTPUT
            echo "BRANCH=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi
          echo "REPO=${{ github.repository }}" >> $GITHUB_OUTPUT
      
      - name: Review with Claude using GitHub MCP
        id: claude-review
        run: |
          cat > review_script.js << 'SCRIPT'
          const REPO = process.env.REPO;
          const PR_NUMBER = process.env.PR_NUMBER;
          const BASE_SHA = process.env.BASE_SHA;
          const HEAD_SHA = process.env.HEAD_SHA;
          const IS_PR = process.env.IS_PR === 'true';
          
          async function reviewCode() {
            // Call Claude API with GitHub MCP tools
            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01'
              },
              body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 8000,
                tools: [
                  {
                    type: 'computer_use_20241022',
                    name: 'mcp_github',
                    mcp_servers: {
                      github: {
                        command: 'npx',
                        args: ['-y', '@modelcontextprotocol/server-github'],
                        env: {
                          GITHUB_PERSONAL_ACCESS_TOKEN: process.env.GITHUB_TOKEN
                        }
                      }
                    }
                  }
                ],
                messages: [{
                  role: 'user',
                  content: IS_PR 
                    ? `Review the pull request #${PR_NUMBER} in repository ${REPO}. 
                       
                       Use the GitHub MCP tools to:
                       1. Get the PR details and files changed
                       2. Analyze the code changes
                       3. Check for issues, bugs, and improvements
                       
                       Provide a comprehensive review with:
                       - Summary of changes
                       - Specific issues found (with file and line numbers)
                       - Security concerns
                       - Performance suggestions
                       - Best practice recommendations
                       
                       Format your response as markdown.`
                    : `Review the latest commit in repository ${REPO} (comparing ${BASE_SHA} to ${HEAD_SHA}).
                       
                       Use the GitHub MCP tools to:
                       1. Get the commit diff
                       2. Analyze the changed files
                       3. Identify potential issues
                       
                       Provide a detailed review with specific suggestions for improvements.
                       Format your response as markdown.`
                }]
              })
            });
            
            const data = await response.json();
            
            // Handle tool calls if Claude needs to use GitHub MCP
            if (data.stop_reason === 'tool_use') {
              console.log('Claude is using GitHub MCP tools...');
              // In production, you'd handle the tool execution loop here
            }
            
            // Extract review text
            const review = data.content
              .filter(item => item.type === 'text')
              .map(item => item.text)
              .join('\n\n');
            
            // Save review
            const fs = require('fs');
            fs.writeFileSync('review.md', review);
            
            // Output for GitHub Actions
            console.log('REVIEW_START');
            console.log(review);
            console.log('REVIEW_END');
          }
          
          reviewCode().catch(console.error);
          SCRIPT
          
          # Run the review script
          node review_script.js > review_output.txt 2>&1
          
          # Extract review from output
          sed -n '/REVIEW_START/,/REVIEW_END/p' review_output.txt | \
            sed '1d;$d' > review.md
          
          # Save to output
          echo "REVIEW<<EOF" >> $GITHUB_OUTPUT
          cat review.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ steps.context.outputs.REPO }}
          PR_NUMBER: ${{ steps.context.outputs.PR_NUMBER }}
          BASE_SHA: ${{ steps.context.outputs.BASE_SHA }}
          HEAD_SHA: ${{ steps.context.outputs.HEAD_SHA }}
          IS_PR: ${{ steps.context.outputs.IS_PR }}
      
      - name: Create or update PR with suggestions
        if: github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip-review]')
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          BASE_BRANCH="main"
          
          # Check for existing PR
          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --base "$BASE_BRANCH" --json number --jq '.[0].number')
          
          REVIEW_BODY="## ðŸ¤– Automated Code Review by Claude

          ${{ steps.claude-review.outputs.REVIEW }}

          ---
          *Generated using Claude AI with GitHub MCP Connector*
          *To skip review, include \`[skip-review]\` in commit message*"
          
          if [ -z "$PR_EXISTS" ]; then
            gh pr create \
              --title "ðŸ¤– Claude Review: Updates to $BRANCH_NAME" \
              --body "$REVIEW_BODY" \
              --base "$BASE_BRANCH" \
              --head "$BRANCH_NAME" || echo "PR creation skipped or failed"
          else
            gh pr comment "$PR_EXISTS" --body "$REVIEW_BODY"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "## ðŸ¤– Claude Code Review

          ${{ steps.claude-review.outputs.REVIEW }}

          ---
          *Powered by Claude AI with GitHub MCP*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create review suggestions as PR review
        if: github.event_name == 'pull_request'
        run: |
          # Parse review.md for specific file/line suggestions and create review comments
          # This is a placeholder - you can extend this to parse Claude's output
          # and create inline PR review comments
          
          gh pr review ${{ github.event.pull_request.number }} \
            --comment \
            --body "âœ… Automated review completed. See comments above for details."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

